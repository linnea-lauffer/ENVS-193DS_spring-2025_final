---
title: "ENVS-193DS_spring-2025_final"
name: "Linnea Lauffer"
date: "2025-06-10"
format:
  html:
    toc: true
    toc-location: left
    toc-float: true
---

# Set Up

```{R}
#| message: false # use this to make sure messages don't show up
#| warning: false # use this to make sure warnings don't show up

# load packages 
library(tidyverse) # general use
library(janitor) # cleaning data frames
library(here) # file organization
library(DHARMa) # check diagnostics 
library(MuMIn) # model selection
library(ggeffects) # getting model predictions

# read in data
sst <- read_csv(here("data", "SST_update2023.csv"))
nest_boxes <- read_csv(here("data", "occdist.csv"))
```

# 1. Research Writing

## a. Transparent Statistical Methods

In part 1, they used a Pearson's correlation test to determine if there is a statistically significant correlation between distance from headwater(km) and annual total nitrogen load(kg year^-1^). 

In part 2, they used a one-way ANOVA to test whether there is a statistically significant difference in average nitrogen load(kg year^-1^) among different nitrogen sources(urban land, atmospheric deposition, fertilizer wastewater treatment, and grasslands). 

## b. More Information Needed

One statistic that should be included is the F-statistic. This is the test statistic for ANOVA that is the ratio of between group variance to within group variance. The F distribution can be used to evaluate significance, and would provide more context.    

Another test that should be included is a Tukey Honestly Significant Difference (HSD) test. This would tell which groups are actually different when you compare them. ANOVA only indicates whether at least one group differs from the others. The Tukey's HSD would provide more detail. 

## c. Suggestions for rewriting

Part 1: We rejected the null hypothesis that there is no correlation between distance from headwater(km) and annual total nitrogen load(kg year^-1^) (Pearson's r=unknown, p=0.02, $\alpha$=unknown). 

Part 2: We rejected the null hypothesis that there is no difference in average nitrogen load(kg year^-1^) between sources(urban land, atmospheric deposition, fertilizer, wastewater treatment, and grasslands) (one-way ANOVA, F = unknown, degrees of freedom = unknown, p=0.02, $\alpha$ = unknown). On average, [unknown source] tend to have a higher average nitrogen load(kg year^-1^) (difference unknown, 95% CI: unknown).

# 2. Data Visualization

## a. Cleaning and Summarizing

```{R}
sst_clean <- sst |> 
  mutate( year = year(date),
          month = month(date, label = TRUE)) |> 
  filter(year %in% 2018:2023) |> 
  group_by(year, month) |> # group by year and month
  summarise(mean_monthly_sst = mean(temp)) |> 
  arrange(desc(year), match(month, month.abb)) |> 
  mutate(year = factor(year, levels = sort(unique(year))))

sst_clean |> slice_sample(n = 5)
str(sst_clean)
```


## b. Visualize the Data

```{R}
ggplot(data = sst_clean,
       aes( x = month,
            y = mean_monthly_sst,
            group = year,
            color = year)) + 
  geom_line() +
  geom_point() + 
  scale_color_brewer(name = "Year", palette = "Reds") +
  labs( x = "Month",
        y = "Mean monthly sea surface temperature (ÂºC)") +
  theme_minimal() +
  theme(panel.background = element_rect(fill = "white", color = "black"), 
        panel.grid = element_blank(),
        legend.position = c(0.1, 0.75),
        axis.ticks = element_line(color = "black"))
```


# 3. Data Analysis

## a. Response Variable

In this data set, the 1s and 0s represent whether a nest box was occupied by a specific species. A value of 1 means that the box was occupied by the indicated species (for example sp = 1 for swift parrot), and a value of 0 means it was occupied by another species or left empty depending on the variable. 

## b. Purpose of Study

The main difference between Swift Parrots and the other two species is that Swift Parrots are critically endangered and they rarely breed in the same location in successive years. As a result, nontarget birds such as Common Starlings and Tree Martins can learn to identify permanently deployed nest boxes as a resource.

## c. Difference in "Seasons"

The data is presented from the summer breeding seasons of 2016 and 2019, when parrots bred at the study area, triggered by a mast tree flowering event. In 2016, the nest boxes were newly deployed and in 2019 the boxes still remained from 2016. 

## d. Table of Models

4 models total:

| Model number | Season | Distance to forest edge | Model description           |
|:------------:|:------:|:-----------------------:|---------------------------- |
| 0            |        |                         | no predictors (null model)  |
| 1            |    X   |            X            | all predictors (full model) |
| 2            |    X   |                         | season only                 |
| 3            |        |            X            | distance to forest edge only|

## e. Run the Models

```{R}
nest_boxes_clean <- nest_boxes  |> # starting data frame
  clean_names() |> # clean column names
  mutate(season = as_factor(season))

# model 0: null model
model0 <- glm(
  sp ~ 1, # formula
  data = nest_boxes_clean, # data frame
  family = "binomial" # for binary data
)

# model 1: all predictors
model1 <- glm(
  sp ~ season + edge_distance, # formula
  data = nest_boxes_clean, # data frame
  family = "binomial" # for binary data
)

# model 2: season only
model2 <- glm(
  sp ~ season, # formula
  data = nest_boxes_clean, # data frame
  family = "binomial" # for binary data 
)

# model 3: distance to forest edge only
model3 <- glm(
  sp ~ edge_distance, # formula
  data = nest_boxes_clean, # data frame
  family = "binomial" # for binary data
)
```


## f. Check the diagnositics 

```{R}
#| message: false # use this to make sure messages don't show up
#| warning: false # use this to make sure warnings don't show up
plot(simulateResiduals(model0)) 
plot(simulateResiduals(model1))
plot(simulateResiduals(model2))
plot(simulateResiduals(model3))
```

## g. Select the Best Model

```{R}
AICc(model0,
     model1,
     model2,
     model3) |> 
  # arranging output in descending order of AIC
  arrange(AICc)
```

The best model as determined by Akaike's Information Criterion (AIC) included both season and distance to forest edge (model1) as predictors of Swift Parrot nest box occupancy (AICc = 226.31). 

## h. Visualize the Model Predictions

```{r}
model1_predictions <- ggpredict(
  model1, # model object
  terms = c("edge_distance", "season") # predictors
) |> 
  # treating this like a regular data frame
  # renaming the columns
  rename(edge_distance = x,
         season = group) |> 
  # making sure that object is recognized as data frame
  as.data.frame() |> 
  # making sure that season is a factor with 2 levels: 2016 and 2019
  mutate(season = fct_relevel(season, "2016", "2019"))

# base layer: ggplot
ggplot(nest_boxes_clean,
       aes(x = edge_distance,
           y = sp, 
           color = season)) +
  geom_point(size = 2,
             alpha = 0.4) +
  geom_ribbon(data = model1_predictions,
                  aes(x = edge_distance,
                      ymin = conf.low,
                      ymax = conf.high,
                      fill = season),
              alpha = 0.4,
              inherit.aes = FALSE) +
  geom_line(data = model1_predictions,
            aes(x = edge_distance,
                y = predicted, 
                color = season)) +
  # manually setting colors
  scale_color_manual(values = c("2016" = "orchid", "2019" = "orange")) +
  scale_fill_manual(values = c("2016" = "orchid", "2019" = "orange")) +
  # labelling x- and y-axis
  labs(x = "Distance to Forest Edge (m)",
       y = "Probability of Nest Box Occupancy",
       title = "Predicted Nest Box Occupancy By Swift Parrots",
       color = "Season",
       fill = "Season") +
  # clean up theme
  theme_minimal() +
  theme(panel.grid = element_blank()) # remove gridlines
```


## i. Write a Caption for Figure 

**Figure 1. Predicted probability of Swift Parrot nest box occupancy as a function of distance to forest edge in two breeding seasons (2016 and 2019).** Points represent observed occupancy (1 = occupied by Swift Parrot, 0 = not occupied), with color indicating breeding season. The solid lines show predicted probabilities from the best model, model1, which includes both season and edge distance as predictors. Shaded ribbons represent 95% confidence intervals around predictions. 
Data source: Stojanovic, Dejan et al. (2021). Do nest boxes breed the target species or its competitors? A case study of a critically endangered bird [Dataset]. Dryad. https://doi.org/10.5061/dryad.83bk3j9sb

## j. Calculate Model Predictions

```{R}
predicted_probabilities <- ggpredict(
  model1,
  terms = c("edge_distance [0,900]", "season")
)

print(predicted_probabilities)
```


## k. Interpret Results

The predicted probability of Swift Parrot nest box occupancy is highest at the forest edge (0 m) and decreases further away (900 m) in both breeding seasons. At the forest edge (0 m), the probability of Swift Parrot nest box occupancy was 0.48(95% CI [0.33, 0.64]) in 2016 and 0.30(95% CI [0.18, 0.44]). At 900 m from the forest edge, occupancy dropped to 0.12(95% CI [0.06, 0.24]) in 2016 and 0.06(95% CI [0.03, 0.13]).This negative relationship between distance from the forest edge and occupancy probability suggests that Swift Parrots prefer nesting sites closer to forest edges. This pattern contrasts with Tree Martins, which showed increased occupancy farther from forest edges, suggesting species-specific habitat preferences likely shaped by competition or resource distribution.  

# 4. Affective and Exploratory Visualizations

## a. Comparing Visualizations